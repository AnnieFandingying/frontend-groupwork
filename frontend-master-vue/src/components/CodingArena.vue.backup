<template>
  <div class="flex flex-col h-full bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="h-12 bg-gray-50 border-b border-gray-100 flex items-center px-4 justify-between">
      <span class="font-semibold text-gray-700 flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-red-400"></span>
        <span class="w-3 h-3 rounded-full bg-yellow-400"></span>
        <span class="w-3 h-3 rounded-full bg-green-400"></span>
        <span class="ml-2 text-sm text-gray-500">æ¯æ—¥æŒ‘æˆ˜: ä»£ç æ¼”ç»ƒ</span>
      </span>
      <div class="flex gap-2 items-center">
        <!-- æ¨¡å¼é€‰æ‹©å™¨ -->
        <select 
          v-model="codeMode" 
          @change="handleModeChange"
          class="px-3 py-1 bg-white border border-gray-300 rounded text-xs font-semibold text-gray-700 cursor-pointer hover:border-orange-500 transition-colors outline-none"
        >
          <option value="html">HTML å®Œæ•´é¡µé¢</option>
          <option value="html-css-js">HTML + CSS + JS</option>
          <option value="javascript">JavaScript</option>
          <option value="vue">Vue æ¨¡æ¿</option>
        </select>
        <span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs rounded font-bold">æå®¢æ¨¡å¼: å¼€å¯</span>
      </div>
    </div>
    
    <!-- åˆ†å‰²è§†å›¾ -->
    <div class="flex-1 flex overflow-hidden">
      <!-- ä»£ç ç¼–è¾‘åŒº -->
      <div class="w-1/2 border-r border-gray-200 flex flex-col relative">
        <!-- ä»£ç é€‰ä¸­æ‚¬æµ®æŒ‰é’® -->
        <div 
          v-if="showFloatingButtons" 
          :style="{ top: floatingButtonsPosition.y + 'px', left: floatingButtonsPosition.x + 'px' }"
          class="absolute z-50 flex gap-1 bg-white rounded-lg shadow-lg border border-gray-200 p-1"
        >
          <button
            @click="handleExplain"
            class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1"
            title="AI è§£é‡Šä»£ç "
          >
            ğŸ’¡ è§£é‡Š
          </button>
          <button
            @click="handleComplete"
            class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1"
            title="AI è¡¥å…¨ä»£ç "
          >
            âœ¨ è¡¥å…¨
          </button>
          <button
            @click="handleFix"
            class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white text-xs font-semibold rounded transition-colors flex items-center gap-1"
            title="AI ä¿®å¤ä»£ç "
          >
            ğŸ”§ ä¿®æ”¹
          </button>
        </div>

        <!-- AI è¾…åŠ©ç»“æœæ‚¬æµ®æ¡† -->
        <div 
          v-if="showAssistPanel" 
          class="absolute z-40 bg-white rounded-lg shadow-2xl border border-gray-300 overflow-hidden"
          :style="{ 
            top: assistPanelPosition.y + 'px', 
            left: assistPanelPosition.x + 'px',
            width: '500px',
            maxHeight: '400px'
          }"
        >
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-2 flex items-center justify-between">
            <span class="font-semibold text-sm flex items-center gap-2">
              <span v-if="currentAction === 'explain'">ğŸ’¡ AI ä»£ç è§£é‡Š</span>
              <span v-else-if="currentAction === 'complete'">âœ¨ AI ä»£ç è¡¥å…¨</span>
              <span v-else-if="currentAction === 'fix'">ğŸ”§ AI ä»£ç ä¿®å¤</span>
            </span>
            <button 
              @click="closeAssistPanel"
              class="hover:bg-white/20 rounded px-2 py-1 transition-colors"
            >
              âœ•
            </button>
          </div>
          <div class="p-4 overflow-y-auto max-h-[350px] bg-gray-50">
            <div v-if="isAssisting" class="flex items-center gap-2 text-gray-600">
              <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"></div>
              <span class="text-sm">AI æ­£åœ¨æ€è€ƒ...</span>
            </div>
            <div v-else-if="assistResult" class="whitespace-pre-wrap font-mono text-sm text-gray-800 leading-relaxed">
              {{ assistResult }}
            </div>
            <div v-else class="text-gray-500 text-sm">
              ç­‰å¾… AI å“åº”...
            </div>
          </div>
        </div>

        <!-- HTML å®Œæ•´é¡µé¢æ¨¡å¼ -->
        <template v-if="codeMode === 'html'">
          <div class="bg-gray-700 text-white px-4 py-2 text-xs font-semibold">
            HTML å®Œæ•´é¡µé¢
          </div>
          <div class="relative flex-1 p-0">
            <textarea
              ref="textareaRef"
              v-model="htmlCode"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥å®Œæ•´çš„ HTML é¡µé¢..."
            />
          </div>
        </template>

        <!-- HTML + CSS + JS åˆ†ç¦»æ¨¡å¼ -->
        <template v-if="codeMode === 'html-css-js'">
          <div class="flex border-b border-gray-600">
            <button 
              v-for="tab in ['HTML', 'CSS', 'JavaScript']" 
              :key="tab"
              @click="activeTab = tab"
              :class="[
                'px-4 py-2 text-xs font-semibold transition-colors',
                activeTab === tab 
                  ? 'bg-gray-700 text-white' 
                  : 'bg-gray-600 text-gray-300 hover:bg-gray-650'
              ]"
            >
              {{ tab }}
            </button>
          </div>
          <div class="relative flex-1 p-0">
            <textarea
              v-show="activeTab === 'HTML'"
              ref="htmlTextareaRef"
              v-model="separateHtml"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ HTML ä»£ç ..."
            />
            <textarea
              v-show="activeTab === 'CSS'"
              ref="cssTextareaRef"
              v-model="separateCss"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ CSS æ ·å¼..."
            />
            <textarea
              v-show="activeTab === 'JavaScript'"
              ref="jsTextareaRef"
              v-model="separateJs"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ JavaScript ä»£ç ..."
            />
          </div>
        </template>

        <!-- JavaScript æ¨¡å¼ -->
        <template v-if="codeMode === 'javascript'">
          <div class="bg-gray-700 text-white px-4 py-2 text-xs font-semibold">
            JavaScript ä»£ç 
          </div>
          <div class="relative flex-1 p-0">
            <textarea
              ref="jsOnlyTextareaRef"
              v-model="jsOnlyCode"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ JavaScript ä»£ç ..."
            />
          </div>
        </template>

        <!-- Vue æ¨¡æ¿æ¨¡å¼ -->
        <template v-if="codeMode === 'vue'">
          <div class="flex border-b border-gray-600">
            <button 
              v-for="tab in ['Template', 'Script', 'Style']" 
              :key="tab"
              @click="activeTab = tab"
              :class="[
                'px-4 py-2 text-xs font-semibold transition-colors',
                activeTab === tab 
                  ? 'bg-gray-700 text-white' 
                  : 'bg-gray-600 text-gray-300 hover:bg-gray-650'
              ]"
            >
              {{ tab }}
            </button>
          </div>
          <div class="relative flex-1 p-0">
            <textarea
              v-show="activeTab === 'Template'"
              ref="vueTemplateRef"
              v-model="vueTemplate"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ Vue æ¨¡æ¿..."
            />
            <textarea
              v-show="activeTab === 'Script'"
              ref="vueScriptRef"
              v-model="vueScript"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ Vue Script (Composition API)..."
            />
            <textarea
              v-show="activeTab === 'Style'"
              ref="vueStyleRef"
              v-model="vueStyle"
              @input="handleChange"
              @mouseup="handleTextSelection"
              @keyup="handleTextSelection"
              class="w-full h-full resize-none p-6 font-mono text-sm leading-6 outline-none bg-[#1e1e1e] text-[#d4d4d4]"
              spellcheck="false"
              placeholder="è¾“å…¥ Vue æ ·å¼..."
            />
          </div>
        </template>
      </div>
      
      <!-- é¢„è§ˆåŒº -->
      <div class="w-1/2 flex flex-col bg-white">
        <div class="bg-gray-700 text-white px-4 py-2 text-xs font-semibold flex items-center justify-between">
          <span>é¢„è§ˆæ•ˆæœ - {{ codeModeLabel }}</span>
          <button 
            @click="clearOutput"
            class="px-2 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs transition-colors"
          >
            æ¸…ç©º
          </button>
        </div>
        
        <!-- æ¸²æŸ“é¢„è§ˆ iframe -->
        <div class="flex-1 overflow-auto">
          <iframe
            ref="previewFrame"
            class="w-full h-full border-0"
          ></iframe>
        </div>
        
        <!-- æ§åˆ¶å°è¾“å‡º -->
        <div class="h-32 border-t border-gray-200 bg-gray-900 text-white overflow-auto">
          <div class="px-4 py-2 text-xs font-semibold border-b border-gray-700">
            æ§åˆ¶å°è¾“å‡º
          </div>
          <div class="p-4 font-mono text-xs space-y-1">
            <div v-if="consoleOutput.length === 0" class="text-gray-500">
              ç­‰å¾…è¿è¡Œä»£ç ...
            </div>
            <div 
              v-for="(log, index) in consoleOutput" 
              :key="index"
              :class="{
                'text-red-400': log.type === 'error',
                'text-yellow-400': log.type === 'warn',
                'text-blue-400': log.type === 'info',
                'text-green-400': log.type === 'success'
              }"
            >
              {{ log.message }}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="h-12 bg-gray-800 text-white flex items-center justify-between px-6">
      <span class="text-xs text-gray-400">å‡†å¤‡å°±ç»ª | æ¨¡å¼: {{ codeModeLabel }}</span>
      <button 
        @click="runCode"
        class="px-4 py-1.5 bg-primary text-white text-xs font-bold rounded hover:bg-orange-600 transition-colors flex items-center gap-2"
      >
        <span>â–¶</span>
        è¿è¡Œä»£ç 
      </button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import confetti from 'canvas-confetti';
import { codeAssistStream } from '../services/codeAssistService';

interface ConsoleLog {
  type: 'log' | 'error' | 'warn' | 'info' | 'success';
  message: string;
}

type CodeMode = 'html' | 'html-css-js' | 'javascript' | 'vue';

// ä»£ç æ¨¡å¼
const codeMode = ref<CodeMode>('html');
const activeTab = ref<string>('HTML');

// ä»£ç é€‰ä¸­ç›¸å…³
const showFloatingButtons = ref(false);
const floatingButtonsPosition = ref({ x: 0, y: 0 });
const selectedCode = ref('');
const currentTextarea = ref<HTMLTextAreaElement | null>(null);

// AI è¾…åŠ©ç›¸å…³
const showAssistPanel = ref(false);
const assistPanelPosition = ref({ x: 0, y: 0 });
const isAssisting = ref(false);
const assistResult = ref('');
const currentAction = ref<'explain' | 'complete' | 'fix'>('explain');

// HTML å®Œæ•´é¡µé¢æ¨¡å¼
const htmlCode = ref<string>(`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»£ç æ¼”ç»ƒ</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
    }
    button {
      background: #FF5722;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    button:hover {
      background: #E64A19;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ‰ æ¬¢è¿æ¥åˆ°ä»£ç æ¼”ç»ƒåœº</h1>
    <p>ä¿®æ”¹ä»£ç ï¼Œç‚¹å‡»è¿è¡ŒæŸ¥çœ‹æ•ˆæœ</p>
    <button onclick="handleClick()">ç‚¹å‡»æˆ‘</button>
    <div id="output"></div>
  </div>

  <script>
    function handleClick() {
      const output = document.getElementById('output');
      output.innerHTML = '<p style="margin-top: 1rem; color: #667eea;">Hello, World! ğŸš€</p>';
      console.log('æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
    }
  <\/script>
</body>
</html>`);

// HTML + CSS + JS åˆ†ç¦»æ¨¡å¼
const separateHtml = ref<string>(`<div class="container">
  <h1>ğŸš€ HTML + CSS + JS æ¨¡å¼</h1>
  <p>è¿™æ˜¯ä¸€ä¸ªåˆ†ç¦»çš„ä»£ç æ¼”ç»ƒç¯å¢ƒ</p>
  <button id="btn">ç‚¹å‡»è®¡æ•°</button>
  <p id="count">ç‚¹å‡»æ¬¡æ•°: 0</p>
</div>`);

const separateCss = ref<string>(`body {
  margin: 0;
  padding: 20px;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.container {
  background: white;
  padding: 3rem;
  border-radius: 15px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  text-align: center;
  max-width: 500px;
}

h1 {
  color: #f5576c;
  margin-bottom: 1rem;
}

button {
  background: #f5576c;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s;
  margin: 1rem 0;
}

button:hover {
  background: #d4455a;
  transform: scale(1.05);
}

#count {
  font-size: 1.2rem;
  color: #333;
  font-weight: bold;
}`);

const separateJs = ref<string>(`let count = 0;
const btn = document.getElementById('btn');
const countDisplay = document.getElementById('count');

btn.addEventListener('click', () => {
  count++;
  countDisplay.textContent = \`ç‚¹å‡»æ¬¡æ•°: \${count}\`;
  console.log('å½“å‰è®¡æ•°:', count);
});

console.log('JavaScript å·²åŠ è½½ï¼');`);

// JavaScript ç‹¬ç«‹æ¨¡å¼
const jsOnlyCode = ref<string>(`// JavaScript ç‹¬ç«‹è¿è¡Œç¯å¢ƒ
const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(n => n * 2);

console.log('åŸæ•°ç»„:', numbers);
console.log('ç¿»å€å:', doubled);

// è®¡ç®—æ€»å’Œ
const sum = numbers.reduce((acc, n) => acc + n, 0);
console.log('æ€»å’Œ:', sum);

// å¼‚æ­¥æ“ä½œç¤ºä¾‹
setTimeout(() => {
  console.log('â° 1ç§’åæ‰§è¡Œ');
}, 1000);

console.log('âœ… JavaScript ä»£ç æ‰§è¡Œå®Œæ¯•ï¼');`);

// Vue æ¨¡æ¿æ¨¡å¼
const vueTemplate = ref<string>(`<div class="vue-container">
  <h1>{{ title }}</h1>
  <p>{{ message }}</p>
  <button @click="increment">ç‚¹å‡»è®¡æ•°: {{ count }}</button>
  <div class="items">
    <div v-for="item in items" :key="item" class="item">
      {{ item }}
    </div>
  </div>
</div>`);

const vueScript = ref<string>(`const title = ref('ğŸ’š Vue 3 å®æ—¶é¢„è§ˆ');
const message = ref('ä½¿ç”¨ Composition API');
const count = ref(0);
const items = ref(['Vue 3', 'Composition API', 'Reactive', 'Template']);

const increment = () => {
  count.value++;
  console.log('è®¡æ•°:', count.value);
};`);

const vueStyle = ref<string>(`body {
  margin: 0;
  padding: 20px;
  background: linear-gradient(135deg, #42b883 0%, #35495e 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.vue-container {
  background: white;
  padding: 3rem;
  border-radius: 15px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.3);
  text-align: center;
  max-width: 500px;
}

h1 {
  color: #42b883;
  margin-bottom: 1rem;
}

button {
  background: #42b883;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.3s;
  margin: 1rem 0;
}

button:hover {
  background: #35495e;
  transform: scale(1.05);
}

.items {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 1rem;
  flex-wrap: wrap;
}

.item {
  background: #f0f0f0;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  color: #35495e;
}`);

const textareaRef = ref<HTMLTextAreaElement | null>(null);
const htmlTextareaRef = ref<HTMLTextAreaElement | null>(null);
const cssTextareaRef = ref<HTMLTextAreaElement | null>(null);
const jsTextareaRef = ref<HTMLTextAreaElement | null>(null);
const jsOnlyTextareaRef = ref<HTMLTextAreaElement | null>(null);
const vueTemplateRef = ref<HTMLTextAreaElement | null>(null);
const vueScriptRef = ref<HTMLTextAreaElement | null>(null);
const vueStyleRef = ref<HTMLTextAreaElement | null>(null);
const previewFrame = ref<HTMLIFrameElement | null>(null);
const consoleOutput = ref<ConsoleLog[]>([]);

const codeModeLabel = computed(() => {
  switch (codeMode.value) {
    case 'html': return 'HTML å®Œæ•´é¡µé¢';
    case 'html-css-js': return 'HTML + CSS + JS';
    case 'javascript': return 'JavaScript';
    case 'vue': return 'Vue æ¨¡æ¿';
    default: return '';
  }
});

const handleModeChange = () => {
  // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½® activeTab
  if (codeMode.value === 'html-css-js') {
    activeTab.value = 'HTML';
  } else if (codeMode.value === 'vue') {
    activeTab.value = 'Template';
  }
  clearOutput();
};

const fireParticles = (x: number, y: number) => {
  confetti({
    particleCount: 5,
    spread: 40,
    origin: { x: x / window.innerWidth, y: y / window.innerHeight },
    colors: ['#FF5722', '#2196F3', '#FFC107'],
    disableForReducedMotion: true,
    scalar: 0.6,
    shapes: ['circle', 'square'],
  });
};

const handleChange = () => {
  const activeTextarea = 
    codeMode.value === 'html' ? textareaRef.value :
    codeMode.value === 'html-css-js' ? 
      (activeTab.value === 'HTML' ? htmlTextareaRef.value : 
       activeTab.value === 'CSS' ? cssTextareaRef.value : jsTextareaRef.value) :
    codeMode.value === 'javascript' ? jsOnlyTextareaRef.value :
    activeTab.value === 'Template' ? vueTemplateRef.value :
    activeTab.value === 'Script' ? vueScriptRef.value : vueStyleRef.value;

  if (activeTextarea) {
    const rect = activeTextarea.getBoundingClientRect();
    const x = rect.left + Math.random() * rect.width; 
    const y = rect.top + Math.random() * rect.height;
    fireParticles(x, y);
  }

  // Screen shake effect
  if (document.body.style) {
    document.body.style.transform = `translate(${Math.random() * 2 - 1}px, ${Math.random() * 2 - 1}px)`;
    setTimeout(() => {
      document.body.style.transform = 'none';
    }, 50);
  }
};

// å¤„ç†æ–‡æœ¬é€‰ä¸­
const handleTextSelection = (event: Event) => {
  const textarea = event.target as HTMLTextAreaElement;
  const selectionStart = textarea.selectionStart;
  const selectionEnd = textarea.selectionEnd;
  
  if (selectionStart !== selectionEnd) {
    const selected = textarea.value.substring(selectionStart, selectionEnd);
    if (selected.trim().length > 0) {
      selectedCode.value = selected;
      currentTextarea.value = textarea;
      
      // è®¡ç®—æ‚¬æµ®æŒ‰é’®ä½ç½®
      const rect = textarea.getBoundingClientRect();
      const textBeforeSelection = textarea.value.substring(0, selectionStart);
      const lines = textBeforeSelection.split('\n').length;
      
      // ç®€åŒ–çš„ä½ç½®è®¡ç®—
      floatingButtonsPosition.value = {
        x: rect.left + 20,
        y: rect.top + (lines * 20) - textarea.scrollTop + 30
      };
      
      showFloatingButtons.value = true;
    } else {
      hideFloatingButtons();
    }
  } else {
    hideFloatingButtons();
  }
};

const hideFloatingButtons = () => {
  showFloatingButtons.value = false;
};

const closeAssistPanel = () => {
  showAssistPanel.value = false;
  assistResult.value = '';
  isAssisting.value = false;
};

// è·å–å½“å‰è¯­è¨€
const getCurrentLanguage = (): string => {
  if (codeMode.value === 'html') return 'html';
  if (codeMode.value === 'javascript') return 'javascript';
  if (codeMode.value === 'html-css-js') {
    if (activeTab.value === 'HTML') return 'html';
    if (activeTab.value === 'CSS') return 'css';
    return 'javascript';
  }
  if (codeMode.value === 'vue') {
    if (activeTab.value === 'Template') return 'vue';
    if (activeTab.value === 'Script') return 'javascript';
    return 'css';
  }
  return 'javascript';
};

// AI è§£é‡Šä»£ç 
const handleExplain = async () => {
  currentAction.value = 'explain';
  await executeAIAssist('explain');
};

// AI è¡¥å…¨ä»£ç 
const handleComplete = async () => {
  currentAction.value = 'complete';
  await executeAIAssist('complete');
};

// AI ä¿®å¤ä»£ç 
const handleFix = async () => {
  currentAction.value = 'fix';
  await executeAIAssist('fix');
};

// æ‰§è¡Œ AI è¾…åŠ©
const executeAIAssist = async (action: 'explain' | 'complete' | 'fix') => {
  if (!selectedCode.value) return;
  
  hideFloatingButtons();
  
  // æ˜¾ç¤ºè¾…åŠ©é¢æ¿
  assistPanelPosition.value = {
    x: floatingButtonsPosition.value.x + 200,
    y: floatingButtonsPosition.value.y - 50
  };
  showAssistPanel.value = true;
  isAssisting.value = true;
  assistResult.value = '';
  
  const language = getCurrentLanguage();
  
  console.log(`ğŸ¤– AI ${action} è¯·æ±‚:`, {
    language,
    codeLength: selectedCode.value.length
  });
  
  try {
    const stream = await codeAssistStream({
      code: selectedCode.value,
      action,
      language,
      context: `å½“å‰æ¨¡å¼: ${codeModeLabel.value}`
    });
    
    for await (const chunk of stream) {
      assistResult.value += chunk;
    }
    
    isAssisting.value = false;
    
  } catch (error) {
    console.error('AI è¾…åŠ©é”™è¯¯:', error);
    assistResult.value = `âŒ AI è¾…åŠ©æœåŠ¡å‡ºé”™: ${error}`;
    isAssisting.value = false;
  }
};

const addLog = (message: string, type: ConsoleLog['type'] = 'log') => {
  consoleOutput.value.push({ type, message });
};

const clearOutput = () => {
  consoleOutput.value = [];
  if (previewFrame.value) {
    const doc = previewFrame.value.contentDocument;
    if (doc) {
      doc.open();
      doc.write('');
      doc.close();
    }
  }
};

const runCode = () => {
  try {
    consoleOutput.value = [];
    addLog(`ğŸš€ å¼€å§‹æ‰§è¡Œä»£ç ... (${codeModeLabel.value})`, 'info');
    
    if (!previewFrame.value) {
      addLog('âŒ é¢„è§ˆæ¡†æ¶æœªå‡†å¤‡å¥½', 'error');
      return;
    }

    const iframe = previewFrame.value;
    const doc = iframe.contentDocument || iframe.contentWindow?.document;
    
    if (!doc) {
      addLog('âŒ æ— æ³•è®¿é—®é¢„è§ˆæ–‡æ¡£', 'error');
      return;
    }

    let finalCode = '';

    // æ ¹æ®ä¸åŒæ¨¡å¼ç”Ÿæˆä»£ç 
    if (codeMode.value === 'html') {
      finalCode = htmlCode.value;
    } else if (codeMode.value === 'javascript') {
      // JavaScript ç‹¬ç«‹æ¨¡å¼
      finalCode = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JavaScript è¿è¡Œç¯å¢ƒ</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Consolas', 'Monaco', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin: 0 0 1rem 0;
    }
    .info {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ JavaScript è¿è¡Œç¯å¢ƒ</h1>
    <p class="info">è¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¾“å‡ºç»“æœ</p>
  </div>
  <script>
` + jsOnlyCode.value + `
  <\/script>
</body>
</html>`;
    } else if (codeMode.value === 'html-css-js') {
      finalCode = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML + CSS + JS</title>
  <style>
` + separateCss.value + `
  </style>
</head>
<body>
` + separateHtml.value + `
  <script>
` + separateJs.value + `
  <\/script>
</body>
</html>`;
    } else if (codeMode.value === 'vue') {
      // Vue æ¨¡å¼ï¼šå°† Vue SFC ç¼–è¯‘ä¸º HTML
      finalCode = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vue æ¨¡æ¿é¢„è§ˆ</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"><\/script>
  <style>
` + vueStyle.value + `
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    const { createApp, ref } = Vue;
    
    createApp({
      setup() {
        ` + vueScript.value + `
        
        return {
          title,
          message,
          count,
          items,
          increment
        };
      },
      template: \`` + vueTemplate.value.replace(/\\/g, '\\\\').replace(/`/g, '\\`') + `\`
    }).mount('#app');
    
    console.log('Vue åº”ç”¨å·²æŒ‚è½½ï¼');
  <\/script>
</body>
</html>`;
    }

    // æ³¨å…¥æ§åˆ¶å°æ‹¦æˆªä»£ç 
    const codeWithConsole = finalCode.replace(
      '</head>',
      `<script>
        (function() {
          const originalLog = console.log;
          const originalError = console.error;
          const originalWarn = console.warn;
          const originalInfo = console.info;
          
          console.log = function(...args) {
            window.parent.postMessage({ 
              type: 'console', 
              method: 'log', 
              args: args.map(String) 
            }, '*');
            originalLog.apply(console, args);
          };
          
          console.error = function(...args) {
            window.parent.postMessage({ 
              type: 'console', 
              method: 'error', 
              args: args.map(String) 
            }, '*');
            originalError.apply(console, args);
          };
          
          console.warn = function(...args) {
            window.parent.postMessage({ 
              type: 'console', 
              method: 'warn', 
              args: args.map(String) 
            }, '*');
            originalWarn.apply(console, args);
          };
          
          console.info = function(...args) {
            window.parent.postMessage({ 
              type: 'console', 
              method: 'info', 
              args: args.map(String) 
            }, '*');
            originalInfo.apply(console, args);
          };
          
          window.addEventListener('error', function(e) {
            window.parent.postMessage({ 
              type: 'console', 
              method: 'error', 
              args: [e.message] 
            }, '*');
          });
        })();
      <\/script>
      </head>`
    );

    // å†™å…¥ä»£ç åˆ° iframe
    doc.open();
    doc.write(codeWithConsole);
    doc.close();
    
    addLog('âœ… ä»£ç æ‰§è¡ŒæˆåŠŸï¼', 'success');
    
    // æ·»åŠ ç²’å­ç‰¹æ•ˆ
    confetti({
      particleCount: 50,
      spread: 70,
      origin: { y: 0.6 },
      colors: ['#FF5722', '#2196F3', '#4CAF50']
    });
    
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    addLog(`âŒ æ‰§è¡Œé”™è¯¯: ${errorMessage}`, 'error');
  }
};

// ç›‘å¬æ¥è‡ª iframe çš„æ§åˆ¶å°æ¶ˆæ¯
if (typeof window !== 'undefined') {
  window.addEventListener('message', (event) => {
    if (event.data.type === 'console') {
      const method = event.data.method as ConsoleLog['type'];
      const message = event.data.args.join(' ');
      addLog(message, method);
    }
  });
}
</script>
